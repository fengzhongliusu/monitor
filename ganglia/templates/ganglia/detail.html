{% extends "ganglia/base.html" %}

{% block title %} 
<div class="row">
    <div class="col-md-6 col-md-offset-3">
        <h2 align=center>
            Resource: {{ resource.res_name }}
            <small>({{resource.res_hostname}})</small>
        </h2>
    </div>
    <div class="col-md-1 col-md-offset-1">
        <small align="right"><a href="{% url 'ganglia:index' %}">Home</a></small>
    </div>
</div>
<div align=center id="test_update"></div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-xs-2 col-xs-offset-1">
            <h4>Metric List</h4>
            <ul class=list-group>
                {% for metric in metric_list %}
                <li class=list-group-item>
                <a href="#" onclick="click_choose('{{metric.mtc_name}}')">{{metric.mtc_name}}</a>
                </li>
                {% endfor %}
            </ul>
            <h4>Related</h4>
            {% if relate_list %}
            <ul>
                {% for res in relate_list %}
                <li><a href="{% url 'ganglia:detail' res.id %}">{{res.res_name}}</a></li>
                {% endfor %}
            </ul>
            {% else %}
            <h5> no related Resource</h5>
            {% endif %}
        </div>
        <div class="col-md-8">
            <div id="middle_container" align="center" class="row">
                {% for metric in metric_list %}
                {% if forloop.counter == 1 %}
                <div id={{ metric.mtc_name }} style="display:block">
                    <div align="center" class="row">
                        <button onclick="button_plot('{{ metric.mtc_name}}/1/',this)" class="btn btn-primary">last hour</button> 
                        <button onclick="button_plot('{{ metric.mtc_name}}/2/',this)" class="btn btn-primary">last day</button> 
                        <button onclick="button_plot('{{ metric.mtc_name}}/3/',this)" class="btn btn-primary">last week</button> 
                        <button onclick="button_plot('{{ metric.mtc_name}}/4/',this)" class="btn btn-primary">last month</button> 
                    </div>
                    <div id="graph_container" class="demo-container">
						<div id="graph_holder1" class="demo-placeholder" style="display:block"></div>
						<div id="graph_holder2" class="demo-placeholder" style="display:none"></div>
						<div id="graph_holder3" class="demo-placeholder" style="display:none"></div>
						<div id="graph_holder4" class="demo-placeholder" style="display:none"></div>
					</div>
                </div>
                {% else %}
                <div id={{ metric.mtc_name }} style="display:none">
                    <div align="center" class="row">
                        <button onclick="button_plot('{{ metric.mtc_name}}/1/',this)" class="btn btn-primary">last hour</button> 
                        <button onclick="button_plot('{{ metric.mtc_name}}/2/',this)" class="btn btn-primary">last day</button> 
                        <button onclick="button_plot('{{ metric.mtc_name}}/3/',this)" class="btn btn-primary">last week</button> 
                        <button onclick="button_plot('{{ metric.mtc_name}}/4/',this)" class="btn btn-primary">last month</button> 
                    </div>
                    <div id="graph_container" class="demo-container">
						<div id="graph_holder1" class="demo-placeholder" style="display:block"></div>
						<div id="graph_holder2" class="demo-placeholder" style="display:none"></div>
						<div id="graph_holder3" class="demo-placeholder" style="display:none"></div>
						<div id="graph_holder4" class="demo-placeholder" style="display:none"></div>
					</div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>



<script type="text/javascript">

/*$(function(){
		var t = new Date(1970,0,1);		
		var options = {
	        year:"numeric", month: "short",day: "numeric", hour: "2-digit", minute: "2-digit"
		};
		t.setSeconds(1425012600+8*3600);
		$("<div id='test_time'></div>").appendTo("body");
		$("#test_time").html(t.toLocaleDateString("en-US",options));
		});
*/

$(function(){
        var elem;
        var init_url;
        {% for metric in metric_list %}
            {% if forloop.counter == 1 %}
                elem = document.getElementById('{{ metric.mtc_name}}');
                init_url = "http://localhost:8000/ganglia/xml/" + '{{ resource.res_hostname}}/{{ metric.mtc_name}}/1/';
            {% endif%}
        {% endfor%}
        gra_elem = elem.querySelector("#graph_container").querySelector("#graph_holder1");
        plot_g(init_url,gra_elem,'1');
    });

/*$(function(){
		var base_url = "http://localhost:8000/ganglia/xml/" + '{{ resource.res_hostname}}/';
		{% for metric in metric_list %}
			var url_array = [];
			url_array.push(base_url + "{{metric.mtc_name}}/1/");
			url_array.push(base_url + "{{metric.mtc_name}}/2/");
			url_array.push(base_url + "{{metric.mtc_name}}/3/");
			url_array.push(base_url + "{{metric.mtc_name}}/4/");
			var child_node= document.getElementById('{{ metric.mtc_name }}').querySelector("#graph_container").children;
			for(var i=0;i<child_node.length;i++){
				plot_g(url_array[i],child_node[]);
			}
		{% endfor %}
		});
*/

function click_choose(text){
    {% for metric in metric_list %}      
    if('{{ metric.mtc_name }}' == text){
        document.getElementById('{{ metric.mtc_name }}').style.display='block';
        item_plot(text);
    }
    else
        document.getElementById('{{ metric.mtc_name }}').style.display='none';
    {% endfor %}
}


/**
 funtion for plotting
 */
function plot_g(url,obj,type){
    var time_fmt;
    var op;
	var update_interval = 2000;

    if(type == '1'){
        time_fmt = "%H:%M";
		op = {
	        hour: "2-digit", minute: "2-digit"
		};
    }
    else if(type == '2'){
        time_fmt = "%y/%m/%d %H:%M";
		op = {
	        month: "short",day: "numeric", hour: "2-digit", minute: "2-digit"
		};
    }
    else if(type == '3'){
        time_fmt = "%y/%m/%d";
		op = {
	        month: "short",day: "numeric"
		};
    }
    else{
        time_fmt = "%y/%m/%d";
		op = {
	        month: "short",day: "numeric"
		};
    }

	var value_ary = get_xml(url);
	if(value_ary.length > 0){
            var plot = $.plot(obj,
					[{data:value_ary,label: obj.parentNode.parentNode.id}],					
					{
                        xaxis: {
                          mode: "time",
                          timezone: "browser",
                          timeformat: time_fmt
                        },
						series: {
							lines: {
								show: true
							},
							points: {
								show: false
							}
						},
						grid: {
							hoverable: true,
							clickable: true 
						},
                        legend:{
                            position:"nw"
                        }
					});

			var x = 0;
			function update(){
				plot.setData([{data:get_xml(url),label: obj.parentNode.parentNode.id}]);
				plot.setupGrid();
				plot.draw();
				x += 1;
				if (x==61)
					x = 1;
				$("#test_update").html(x);
				setTimeout(update,2000);
			}
			update();

			$("<div id='tooltip'></div>").css({
				position: "absolute",
				display: "none",
				border: "1px solid #faa",
				"border-radius": "5px",
				padding: "3px",
				"background-color": "#fee",
				opacity: 0.90
			}).appendTo("body");

			$(obj).bind("plothover", function (event, pos, item) {
					if (item) {
						var x = item.datapoint[0]/1000 + 8*3600,
							y = item.datapoint[1].toFixed(2);
						var t = new Date(1970,0,1);
						t.setSeconds(x);
						$("#tooltip").html(t.toLocaleDateString("en-US",op)+"<br/>"+"value: "+y).
							css({top: item.pageY+5, left: item.pageX+5}).
							fadeIn(150);
					} else {
						$("#tooltip").hide();
					}
			});
    
	}
	else{
		obj.innerHTML = "failed to get msg!!";
	}
}



/**
 function to update in specific time interval
 **/

/**
  function for getting xml data from rrd
**/
function get_xml(req_url){
	var v_array = [];
    var xml_http = new XMLHttpRequest();
    xml_http.open("GET",req_url,false);
    xml_http.send();
	if(xml_http.readyState==4 && xml_http.status==200){
		xmlDoc = jQuery.parseXML(xml_http.responseText);
		$(xmlDoc).find('row').each(function(){
			var time = parseFloat($(this).children('t').text());
			var value = parseFloat($(this).children('v').text());
			v_array.push([time*1000,value]);      //time series xaxis require x to be millis
		});
	}
	return v_array;
}

/**
  plot according to the button clicked
 */
function button_plot(url,obj){
	var base_url;
	var child_node;
	var graph_obj;
	var time_type;
	time_type = url.charAt(url.length-2);
	base_url = "http://localhost:8000/ganglia/xml/" + '{{ resource.res_hostname}}/' + url;
	//get child by id 
	graph_id = "#graph_holder"+time_type;
	graph_obj = obj.parentNode.parentNode.querySelector("#graph_container").querySelector(graph_id);
	child_node = graph_obj.parentNode.children;
	for(var i=0;i<child_node.length;i++)
		child_node[i].style.display = 'none';
	graph_obj.style.display = 'block';
	plot_g(base_url,graph_obj,time_type);
}

/**
  plot according list item clicked 
 **/
function item_plot(m_name){
	var elem_plot;
	var url_item;
	var time_type;
	time_type = '1';
	url_item= "http://localhost:8000/ganglia/xml/" + '{{ resource.res_hostname}}/' + m_name + "/1/";
	elem_plot= document.getElementById(m_name).querySelector("#graph_container").querySelector("#graph_holder1");
	plot_g(url_item,elem_plot,'1');
}

//show data pair to validate the graph
//$("<div id='text'></div>").appendTo(graph_obj.parentNode);
//$("#text").html(xml_http.responseText);
</script>

{% endblock %}
